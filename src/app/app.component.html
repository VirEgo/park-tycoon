<div class="main-wrapper flex h-screen w-screen bg-gray-900 text-white font-sans overflow-hidden select-none">

  <!-- Sidebar (Tools) -->
  <app-sidebar *ngIf="showSidebar()" [isParkClosed]="isParkClosed()" [money]="money()"
    [selectedToolId]="selectedToolId()" [selectedToolCategory]="selectedToolCategory()"
    [getBuildingsByCategory]="getBuildingsByCategory.bind(this)" (toolSelected)="selectTool($event.category, $event.id)"
    (loadDemo)="loadDemoPark()" (togglePark)="toggleParkState()" (reset)="resetGame()">
  </app-sidebar>


  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
  <main class="content-wrapper flex-1 flex flex-col relative bg-gray-800">

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <header class="h-16 bg-gray-900 border-b border-gray-700 flex items-center justify-between px-6 shadow-md z-10">
      <div class="flex items-center space-x-8">
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 text-lg">
            üí∞
          </div>
          <div>
            <div class="text-xs text-gray-400">–ë—é–¥–∂–µ—Ç</div>
            <div class="text-xl font-mono font-bold text-white">{{ money() | number:'1.0-0' }}</div>
          </div>
        </div>

        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-lg">üë•
          </div>
          <div>
            <div class="text-xs text-gray-400">–ì–æ—Å—Ç–∏</div>
            <div class="text-xl font-mono font-bold text-white">{{ guests().length }}</div>
          </div>
        </div>

        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 text-lg">üìÖ
          </div>
          <div>
            <div class="text-xs text-gray-400">–î–µ–Ω—å</div>
            <div class="text-xl font-mono font-bold text-white">{{ dayCount() }}</div>
          </div>
        </div>

        <div class="flex items-center space-x-2" *ngIf="false">
          <div class="flex gap-1">
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect width="20" height="20" fill="none" />

              <rect x="6" y="1" width="8" height="4" fill="#222034" />
              <rect x="4" y="5" width="12" height="1" fill="#222034" />

              <rect x="6" y="6" width="8" height="5" fill="#d9a066" />
              <rect x="7" y="7" width="2" height="2" fill="#222034" />
              <rect x="11" y="7" width="2" height="2" fill="#222034" />
              <rect x="7" y="10" width="6" height="1" fill="#663931" />

              <rect x="4" y="11" width="12" height="8" fill="#323c39" />
              <rect x="9" y="11" width="2" height="2" fill="#ffffff" />
              <rect x="9" y="13" width="2" height="4" fill="#ac3232" />
            </svg>

            <!-- Child with a baloon -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="4" width="8" height="3" fill="#663931" />

              <rect x="7" y="7" width="6" height="4" fill="#d9a066" />
              <rect x="8" y="8" width="1" height="1" fill="#222034" />
              <rect x="11" y="8" width="1" height="1" fill="#222034" />
              <rect x="8" y="10" width="4" height="1" fill="#ac3232" />

              <rect x="6" y="11" width="8" height="8" fill="#6abe30" />

              <rect x="1" y="1" width="6" height="7" fill="#d95763" />
              <rect x="4" y="8" width="1" height="8" fill="#ffffff" />
              <rect x="4" y="13" width="2" height="2" fill="#d9a066" />
            </svg>

            <!-- Mechanic -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="2" width="8" height="3" fill="#fbf236" />
              <rect x="5" y="5" width="10" height="1" fill="#fbf236" />

              <rect x="6" y="6" width="8" height="4" fill="#d9a066" />
              <rect x="6" y="7" width="8" height="2" fill="#76428a" />

              <rect x="5" y="10" width="10" height="9" fill="#df7126" />

              <rect x="1" y="7" width="3" height="2" fill="#9badb7" />
              <rect x="2" y="9" width="1" height="6" fill="#9badb7" />
              <rect x="1" y="15" width="3" height="2" fill="#9badb7" />
              <rect x="2" y="11" width="2" height="2" fill="#d9a066" />
            </svg>

            <!-- Mascote -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="4" y="2" width="3" height="3" fill="#4b2d26" />
              <rect x="13" y="2" width="3" height="3" fill="#4b2d26" />

              <rect x="4" y="5" width="12" height="8" fill="#8f563b" />

              <rect x="7" y="8" width="6" height="4" fill="#d9a066" />
              <rect x="9" y="9" width="2" height="1" fill="#222034" />

              <rect x="6" y="7" width="1" height="1" fill="#222034" />
              <rect x="13" y="7" width="1" height="1" fill="#222034" />

              <rect x="5" y="13" width="10" height="7" fill="#8f563b" />
              <rect x="8" y="14" width="4" height="4" fill="#d9a066" />
            </svg>

            <!-- Happy visitor -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="4" width="8" height="3" fill="#663931" />

              <rect x="7" y="7" width="6" height="4" fill="#d9a066" />
              <rect x="8" y="8" width="1" height="1" fill="#222034" />
              <rect x="11" y="8" width="1" height="1" fill="#222034" />
              <rect x="8" y="10" width="4" height="1" fill="#ac3232" />

              <rect x="6" y="11" width="8" height="8" fill="#6abe30" />

              <rect x="1" y="1" width="6" height="7" fill="#d95763" />
              <rect x="4" y="8" width="1" height="8" fill="#ffffff" />
              <rect x="4" y="13" width="2" height="2" fill="#d9a066" />
            </svg>

            <!-- Janitor -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="2" width="8" height="2" fill="#306082" />
              <rect x="6" y="4" width="10" height="1" fill="#306082" />

              <rect x="7" y="5" width="6" height="4" fill="#d9a066" />
              <rect x="8" y="6" width="1" height="1" fill="#222034" />
              <rect x="11" y="6" width="1" height="1" fill="#222034" />

              <rect x="6" y="9" width="8" height="10" fill="#5b6ee1" />
              <rect x="7" y="9" width="1" height="3" fill="#4b5bab" />
              <rect x="12" y="9" width="1" height="3" fill="#4b5bab" />

              <rect x="16" y="4" width="2" height="10" fill="#663931" />
              <rect x="15" y="14" width="4" height="5" fill="#fbf236" />
            </svg>

            <!-- Tourist -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="7" y="5" width="6" height="4" fill="#d9a066" />
              <rect x="5" y="3" width="10" height="2" fill="#eec39a" />
              <rect x="6" y="2" width="8" height="1" fill="#eec39a" />
              <rect x="6" y="9" width="8" height="6" fill="#45a1ff" />
              <rect x="8" y="11" width="4" height="3" fill="#333" />
              <rect x="9" y="12" width="2" height="1" fill="#555" />
              <rect x="7" y="15" width="2" height="4" fill="#d9a066" />
              <rect x="11" y="15" width="2" height="4" fill="#d9a066" />
            </svg>

            <!-- Elder -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="2" width="8" height="3" fill="#d3d3d3" />
              <rect x="5" y="4" width="1" height="2" fill="#d3d3d3" />
              <rect x="14" y="4" width="1" height="2" fill="#d3d3d3" />
              <rect x="6" y="5" width="8" height="4" fill="#d9a066" />
              <rect x="6" y="6" width="3" height="1" fill="#333" />
              <rect x="11" y="6" width="3" height="1" fill="#333" />
              <rect x="5" y="9" width="10" height="7" fill="#5d4037" />
              <rect x="14" y="11" width="1" height="8" fill="#8d6e63" />
            </svg>

            <!-- Punk -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="9" y="1" width="2" height="5" fill="#ff00ff" />
              <rect x="7" y="5" width="6" height="4" fill="#d9a066" />
              <rect x="6" y="9" width="8" height="6" fill="#222" />
              <rect x="7" y="15" width="2" height="4" fill="#444" />
              <rect x="11" y="15" width="2" height="4" fill="#444" />
            </svg>

            <!-- Business -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="2" width="8" height="3" fill="#5d4037" />
              <rect x="5" y="4" width="1" height="6" fill="#5d4037" />
              <rect x="14" y="4" width="1" height="6" fill="#5d4037" />
              <rect x="6" y="5" width="8" height="4" fill="#d9a066" />
              <rect x="6" y="9" width="8" height="6" fill="#37474f" />
              <rect x="9" y="9" width="2" height="4" fill="#fff" />
            </svg>

            <!-- Runner -->
            <svg width="64" height="64" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges">
              <rect x="6" y="4" width="8" height="1" fill="#ffeb3b" />
              <rect x="6" y="3" width="8" height="5" fill="#d9a066" />
              <rect x="7" y="8" width="6" height="7" fill="#f44336" />
              <rect x="7" y="15" width="2" height="4" fill="#2196f3" />
              <rect x="11" y="15" width="2" height="4" fill="#2196f3" />
            </svg>
          </div>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <button (click)="toggleSidebar()"
          class="px-3 py-2 rounded bg-gray-700 hover:bg-gray-600 font-medium text-sm transition-colors border border-gray-600 flex items-center gap-2">
          <span>{{ showSidebar() ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å' }}</span>
        </button>

        <button (click)="openExpansionPanel()"
          class="px-4 py-2 rounded bg-green-700 hover:bg-green-600 font-medium text-sm transition-colors border border-green-600 flex items-center gap-2">
          <span>üó∫Ô∏è</span>
          <span>–ö—É–ø–∏—Ç—å –∑–µ–º–ª—é</span>
        </button>

        <button (click)="openSkinsGallery()"
          class="px-4 py-2 rounded bg-purple-700 hover:bg-purple-600 font-medium text-sm transition-colors border border-purple-600 flex items-center gap-2">
          <span>üé®</span>
          <span>–°–∫–∏–Ω—ã</span>
        </button>

        <button (click)="repairAllBroken()"
          class="px-4 py-2 rounded bg-amber-700 hover:bg-amber-600 font-medium text-sm transition-colors border border-amber-600 flex items-center gap-2">
          <span>üõ†Ô∏è</span>
          <span>–ü–æ—á–∏–Ω–∏—Ç—å –≤—Å–µ</span>
        </button>

        <button (click)="toggleGuestStats()" [class.bg-blue-600]="showGuestStats()"
          class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 font-medium text-sm transition-colors border border-gray-600 flex items-center gap-2">
          <span>üìä</span>
          <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </button>

        <button (click)="isPaused.set(!isPaused())"
          class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 font-medium text-sm transition-colors border border-gray-600">
          {{ isPaused() ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞' }}
        </button>
      </div>
    </header>

    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ (–ö–∞–Ω–≤–∞—Å) -->
    <div
      class="park-wrapper flex-1 overflow-hidden bg-black relative flex items-start justify-center cursor-crosshair bg-gray-900 p-6">

      <!-- Canvas Container -->
      <div class="relative shadow-2xl overflow-hidden">
        <canvas #gameCanvas (mousedown)="handleCanvasMouseDown($event)" (mousemove)="handleCanvasMouseMove($event)"
          (dblclick)="handleCanvasDoubleClick($event)" (wheel)="handleCanvasWheel($event)"
          (contextmenu)="handleCanvasMouseDown($event); $event.preventDefault()" class="block">
        </canvas>
      </div>
      <div class="zoom-btn flex items-center bg-gray-800 border border-gray-700 rounded px-2 py-1 space-x-1">
        <button (click)="zoomOut()"
          class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-lg leading-none">-</button>
        <div class="text-xs font-mono w-12 text-center">{{ (viewScale() * 100) | number:'1.0-0' }}%</div>
        <button (click)="zoomIn()" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-lg leading-none">+</button>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥–æ—Å—Ç–µ–π -->
    <div *ngIf="showGuestStats() && guestStats() as stats"
      class="absolute top-20 right-6 w-64 bg-gray-800/95 backdrop-blur border border-gray-600 rounded-lg shadow-2xl p-4 z-30 animate-slide-in">
      <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
        <h3 class="font-bold text-white">–°–≤–æ–¥–∫–∞ –ø–æ –≥–æ—Å—Ç—è–º</h3>
        <button (click)="toggleGuestStats()" class="text-gray-400 hover:text-white">‚úï</button>
      </div>

      <div class="space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-400">–°—á–∞—Å—Ç—å–µ:</span>
          <div class="flex items-center gap-2">
            <div class="w-20 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-yellow-500" [style.width.%]="stats.happiness"></div>
            </div>
            <span class="font-mono">{{stats.happiness | number:'1.0-0'}}%</span>
          </div>
        </div>

        <div class="flex justify-between">
          <span class="text-gray-400">–°—ã—Ç–æ—Å—Ç—å:</span>
          <div class="flex items-center gap-2">
            <div class="w-20 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-orange-500" [style.width.%]="stats.satiety"></div>
            </div>
            <span class="font-mono">{{stats.satiety | number:'1.0-0'}}%</span>
          </div>
        </div>

        <div class="flex justify-between">
          <span class="text-gray-400">–ñ–∞–∂–¥–∞:</span>
          <div class="flex items-center gap-2">
            <div class="w-20 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500" [style.width.%]="stats.hydration"></div>
            </div>
            <span class="font-mono">{{stats.hydration | number:'1.0-0'}}%</span>
          </div>
        </div>

        <div class="flex justify-between">
          <span class="text-gray-400">–≠–Ω–µ—Ä–≥–∏—è:</span>
          <div class="flex items-center gap-2">
            <div class="w-20 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-green-500" [style.width.%]="stats.energy"></div>
            </div>
            <span class="font-mono">{{stats.energy | number:'1.0-0'}}%</span>
          </div>
        </div>

        <div class="flex justify-between">
          <span class="text-gray-400">–í–µ—Å–µ–ª—å–µ:</span>
          <div class="flex items-center gap-2">
            <div class="w-20 h-2 bg-gray-700 rounded-full overflow-hidden">
              <div class="h-full bg-purple-500" [style.width.%]="stats.fun"></div>
            </div>
            <span class="font-mono">{{stats.fun | number:'1.0-0'}}%</span>
          </div>
        </div>

        <div class="pt-2 border-t border-gray-700 flex justify-between">
          <span class="text-gray-400">–°—Ä. –±—é–¥–∂–µ—Ç:</span>
          <span class="text-green-400 font-mono">{{stats.money | number:'1.0-0'}}</span>
        </div>
      </div>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ—Å—Ç–µ -->
    <app-guest-details *ngIf="selectedGuest() as guest" [guest]="guest" [guestImageSrc]="getGuestImageSrc(guest)"
      (close)="closeGuestDetails()">
    </app-guest-details>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Toast) -->
    <div class="absolute bottom-4 right-4 flex flex-col items-end space-y-2 pointer-events-none">
      <div *ngFor="let msg of notifications()"
        class="bg-gray-800 text-white text-sm py-2 px-4 rounded shadow-lg border-l-4 border-yellow-500 animate-slide-in">
        {{ msg }}
      </div>
    </div>

    <!-- Modal -->
    <div *ngIf="showConfirmModal()"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm animate-fade-in">
      <div
        class="bg-gray-800 border border-gray-600 rounded-lg shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
        <h3 class="text-xl font-bold text-white mb-2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
        <p class="text-gray-300 mb-6">
          –ù–∞ —ç—Ç–æ–π –∫–ª–µ—Ç–∫–µ —É–∂–µ –µ—Å—Ç—å —Å—Ç—Ä–æ–µ–Ω–∏–µ. –°–Ω–µ—Å—Ç–∏ –µ–≥–æ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤–æ–µ?
        </p>
        <div class="flex justify-end space-x-3">
          <button (click)="cancelBuild()"
            class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white transition-colors">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button (click)="confirmBuild()"
            class="px-4 py-2 rounded bg-red-600 hover:bg-red-500 text-white font-bold transition-colors">
            –°–Ω–µ—Å—Ç–∏ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å
          </button>
        </div>
      </div>
    </div>

    <!-- Upgrade Panel Modal -->
    <app-upgrade-panel *ngIf="showUpgradePanel() && selectedBuildingForUpgrade() as selected"
      [building]="selected.building" [cellX]="selected.cellX" [cellY]="selected.cellY" [currentMoney]="money()"
      [isBroken]="selected.isBroken" [repairCost]="selected.repairCost" (onClose)="closeUpgradePanel()"
      (onUpgrade)="handleUpgrade($event)" (onThemeApplied)="handleThemeApplied($event)"
      (onRepair)="handleRepair($event)" />

  </main>
</div>